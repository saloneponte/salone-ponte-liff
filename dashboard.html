<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Salone Ponte 管理ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <style>
    .tab-active {
      @apply bg-blue-500 text-white border-blue-500;
    }
    .card {
      @apply bg-white rounded-lg shadow-md p-6 border border-gray-200;
    }
    .metric-card {
      @apply bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200;
    }
    .metric-value {
      @apply text-2xl font-bold text-blue-600;
    }
    .metric-label {
      @apply text-sm text-gray-600 mt-1;
    }
    .chart-container {
      @apply bg-white p-4 rounded-lg shadow-md;
      height: 400px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- ヘッダー -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Salone Ponte 管理ダッシュボード</h1>
      <p class="text-gray-600">売上分析・顧客管理・予約管理</p>
    </div>

    <!-- メトリクスカード -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="card metric-card">
        <div class="metric-value" id="todayRevenue">¥0</div>
        <div class="metric-label">今日の売上</div>
      </div>
      <div class="card metric-card">
        <div class="metric-value" id="monthlyRevenue">¥0</div>
        <div class="metric-label">今月の売上</div>
      </div>
      <div class="card metric-card">
        <div class="metric-value" id="todayReservations">0</div>
        <div class="metric-label">今日の予約数</div>
      </div>
      <div class="card metric-card">
        <div class="metric-value" id="totalCustomers">0</div>
        <div class="metric-label">総顧客数</div>
      </div>
    </div>

    <!-- タブナビゲーション -->
    <div class="flex flex-wrap border-b border-gray-200 mb-6">
      <button class="tab-button px-6 py-3 font-medium border-b-2 border-transparent hover:border-gray-300 transition-colors" data-tab="analytics">売上分析</button>
      <button class="tab-button px-6 py-3 font-medium border-b-2 border-transparent hover:border-gray-300 transition-colors" data-tab="reservations">予約管理</button>
      <button class="tab-button px-6 py-3 font-medium border-b-2 border-transparent hover:border-gray-300 transition-colors" data-tab="customers">顧客管理</button>
      <button class="tab-button px-6 py-3 font-medium border-b-2 border-transparent hover:border-gray-300 transition-colors" data-tab="staff">スタッフ管理</button>
    </div>

    <!-- 売上分析タブ -->
    <div id="analytics-tab" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- 売上推移グラフ -->
        <div class="chart-container">
          <h3 class="text-lg font-semibold mb-4">売上推移（過去30日）</h3>
          <canvas id="revenueChart"></canvas>
        </div>
        
        <!-- メニュー別売上 -->
        <div class="chart-container">
          <h3 class="text-lg font-semibold mb-4">メニュー別売上</h3>
          <canvas id="menuChart"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- スタッフ別売上 -->
        <div class="chart-container">
          <h3 class="text-lg font-semibold mb-4">スタッフ別売上</h3>
          <canvas id="staffChart"></canvas>
        </div>
        
        <!-- 時間帯別予約数 -->
        <div class="chart-container">
          <h3 class="text-lg font-semibold mb-4">時間帯別予約数</h3>
          <canvas id="timeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 予約管理タブ -->
    <div id="reservations-tab" class="tab-content hidden">
      <div class="card">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
          <h3 class="text-lg font-semibold mb-4 sm:mb-0">予約一覧</h3>
          <div class="flex flex-col sm:flex-row gap-2">
            <input type="date" id="reservationDateFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <select id="reservationStatusFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">全ステータス</option>
              <option value="confirmed">確定</option>
              <option value="cancelled">キャンセル</option>
              <option value="completed">完了</option>
            </select>
            <button id="refreshReservations" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">更新</button>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto">
            <thead>
              <tr class="bg-gray-50">
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">日時</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">顧客名</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">メニュー</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">スタッフ</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">金額</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">ステータス</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">操作</th>
              </tr>
            </thead>
            <tbody id="reservationsTableBody">
              <!-- データは JavaScript で動的に挿入 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 顧客管理タブ -->
    <div id="customers-tab" class="tab-content hidden">
      <div class="card">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
          <h3 class="text-lg font-semibold mb-4 sm:mb-0">顧客一覧</h3>
          <div class="flex flex-col sm:flex-row gap-2">
            <input type="text" id="customerSearchInput" placeholder="顧客名で検索" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <select id="customerSegmentFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">全セグメント</option>
              <option value="vip">VIP顧客</option>
              <option value="regular">常連顧客</option>
              <option value="new">新規顧客</option>
              <option value="inactive">休眠顧客</option>
            </select>
            <button id="refreshCustomers" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">更新</button>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto">
            <thead>
              <tr class="bg-gray-50">
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">顧客名</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">電話番号</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">来店回数</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">最終来店</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">累計金額</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">セグメント</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">操作</th>
              </tr>
            </thead>
            <tbody id="customersTableBody">
              <!-- データは JavaScript で動的に挿入 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- スタッフ管理タブ -->
    <div id="staff-tab" class="tab-content hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
          <h3 class="text-lg font-semibold mb-4">スタッフ一覧</h3>
          <div id="staffList">
            <!-- スタッフカードは JavaScript で動的に挿入 -->
          </div>
        </div>
        
        <div class="card">
          <h3 class="text-lg font-semibold mb-4">スタッフパフォーマンス</h3>
          <canvas id="staffPerformanceChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- モーダル -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modalTitle" class="text-lg font-semibold">詳細</h3>
        <button id="closeModal" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="modalContent">
        <!-- モーダル内容は JavaScript で動的に挿入 -->
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Firebase 初期化
    const firebaseConfig = {
      apiKey: "AIzaSyAK14FMyp7VGYZPakGDmLdgHsvvxT-b0TM",
      authDomain: "salone-ponte-fceca.firebaseapp.com",
      projectId: "salone-ponte-fceca",
      storageBucket: "salone-ponte-fceca.appspot.com",
      messagingSenderId: "463711728652",
      appId: "1:463711728652:web:59c749e11d201b26b86a29",
      measurementId: "G-MPWGTB6R7C"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // グローバル変数
    let reservationsData = [];
    let customersData = [];
    let staffsData = [];
    let menusData = [];
    let charts = {};

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      initializeTabs();
      loadAllData();
      setupEventListeners();
    });

    // タブ初期化
    function initializeTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.dataset.tab;
          
          // タブボタンのアクティブ状態を更新
          tabButtons.forEach(btn => btn.classList.remove('tab-active'));
          button.classList.add('tab-active');
          
          // タブコンテンツの表示/非表示を切り替え
          tabContents.forEach(content => {
            if (content.id === `${tabId}-tab`) {
              content.classList.remove('hidden');
            } else {
              content.classList.add('hidden');
            }
          });
          
          // タブ切り替え時の処理
          if (tabId === 'analytics') {
            renderCharts();
          }
        });
      });

      // 最初のタブをアクティブに
      if (tabButtons.length > 0) {
        tabButtons[0].click();
      }
    }

    // イベントリスナー設定
    function setupEventListeners() {
      document.getElementById('refreshReservations').addEventListener('click', loadReservations);
      document.getElementById('refreshCustomers').addEventListener('click', loadCustomers);
      document.getElementById('closeModal').addEventListener('click', closeModal);
      
      // フィルター
      document.getElementById('reservationDateFilter').addEventListener('change', filterReservations);
      document.getElementById('reservationStatusFilter').addEventListener('change', filterReservations);
      document.getElementById('customerSearchInput').addEventListener('input', filterCustomers);
      document.getElementById('customerSegmentFilter').addEventListener('change', filterCustomers);
    }

    // 全データ読み込み
    async function loadAllData() {
      try {
        await Promise.all([
          loadReservations(),
          loadCustomers(),
          loadStaffs(),
          loadMenus()
        ]);
        updateMetrics();
        renderCharts();
      } catch (error) {
        console.error('データ読み込みエラー:', error);
        showError('データの読み込みに失敗しました');
      }
    }

    // 予約データ読み込み
    async function loadReservations() {
      try {
        const snapshot = await db.collection('reservations').orderBy('datetime', 'desc').get();
        reservationsData = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          reservationsData.push({
            id: doc.id,
            ...data,
            datetime: new Date(data.datetime),
            createdAt: new Date(data.createdAt)
          });
        });
        renderReservationsTable();
      } catch (error) {
        console.error('予約データ読み込みエラー:', error);
      }
    }

    // 顧客データ読み込み
    async function loadCustomers() {
      try {
        const snapshot = await db.collection('customers').get();
        customersData = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          const reservations = data.reservations || [];
          
          // 顧客分析データを計算
          const visitCount = reservations.length;
          const totalAmount = reservations.reduce((sum, res) => sum + (res.price || 0), 0);
          const lastVisit = reservations.length > 0 ? 
            new Date(Math.max(...reservations.map(r => new Date(r.datetime).getTime()))) : null;
          
          // 顧客セグメント判定
          const segment = determineCustomerSegment(visitCount, lastVisit, totalAmount);
          
          customersData.push({
            id: doc.id,
            ...data,
            visitCount,
            totalAmount,
            lastVisit,
            segment
          });
        });
        renderCustomersTable();
      } catch (error) {
        console.error('顧客データ読み込みエラー:', error);
      }
    }

    // スタッフデータ読み込み
    async function loadStaffs() {
      try {
        const snapshot = await db.collection('staffs').get();
        staffsData = [];
        snapshot.forEach(doc => {
          staffsData.push({
            id: doc.id,
            ...doc.data()
          });
        });
        renderStaffList();
      } catch (error) {
        console.error('スタッフデータ読み込みエラー:', error);
      }
    }

    // メニューデータ読み込み
    async function loadMenus() {
      try {
        const snapshot = await db.collection('menus').get();
        menusData = [];
        snapshot.forEach(doc => {
          menusData.push({
            id: doc.id,
            ...doc.data()
          });
        });
      } catch (error) {
        console.error('メニューデータ読み込みエラー:', error);
      }
    }

    // メトリクス更新
    function updateMetrics() {
      const today = new Date();
      const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

      // 今日の予約と売上
      const todayReservations = reservationsData.filter(r => 
        r.datetime >= todayStart && r.datetime < new Date(todayStart.getTime() + 24 * 60 * 60 * 1000)
      );
      const todayRevenue = todayReservations.reduce((sum, r) => sum + (r.price || 0), 0);

      // 今月の売上
      const monthlyReservations = reservationsData.filter(r => r.datetime >= monthStart);
      const monthlyRevenue = monthlyReservations.reduce((sum, r) => sum + (r.price || 0), 0);

      // DOM更新
      document.getElementById('todayRevenue').textContent = `¥${todayRevenue.toLocaleString()}`;
      document.getElementById('monthlyRevenue').textContent = `¥${monthlyRevenue.toLocaleString()}`;
      document.getElementById('todayReservations').textContent = todayReservations.length;
      document.getElementById('totalCustomers').textContent = customersData.length;
    }

    // 顧客セグメント判定
    function determineCustomerSegment(visitCount, lastVisit, totalAmount) {
      const now = new Date();
      const daysSinceLastVisit = lastVisit ? 
        Math.floor((now - lastVisit) / (1000 * 60 * 60 * 24)) : 999;

      if (totalAmount >= 50000 && visitCount >= 10) return 'vip';
      if (visitCount >= 5 && daysSinceLastVisit <= 60) return 'regular';
      if (visitCount <= 2) return 'new';
      if (daysSinceLastVisit > 90) return 'inactive';
      return 'regular';
    }

    // チャート描画
    function renderCharts() {
      renderRevenueChart();
      renderMenuChart();
      renderStaffChart();
      renderTimeChart();
      renderStaffPerformanceChart();
    }

    // 売上推移チャート
    function renderRevenueChart() {
      const ctx = document.getElementById('revenueChart').getContext('2d');
      
      // 過去30日のデータを準備
      const last30Days = [];
      const revenueData = [];
      
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);
        
        const dayReservations = reservationsData.filter(r => 
          r.datetime >= dayStart && r.datetime < dayEnd
        );
        const dayRevenue = dayReservations.reduce((sum, r) => sum + (r.price || 0), 0);
        
        last30Days.push(date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
        revenueData.push(dayRevenue);
      }

      if (charts.revenue) charts.revenue.destroy();
      
      charts.revenue = new Chart(ctx, {
        type: 'line',
        data: {
          labels: last30Days,
          datasets: [{
            label: '売上',
            data: revenueData,
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '¥' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // メニュー別売上チャート
    function renderMenuChart() {
      const ctx = document.getElementById('menuChart').getContext('2d');
      
      // メニュー別売上集計
      const menuRevenue = {};
      reservationsData.forEach(r => {
        const menuName = r.menuName || 'その他';
        menuRevenue[menuName] = (menuRevenue[menuName] || 0) + (r.price || 0);
      });

      const labels = Object.keys(menuRevenue);
      const data = Object.values(menuRevenue);

      if (charts.menu) charts.menu.destroy();

      charts.menu = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#ef4444', '#f97316', '#eab308', '#22c55e', 
              '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // スタッフ別売上チャート
    function renderStaffChart() {
      const ctx = document.getElementById('staffChart').getContext('2d');
      
      // スタッフ別売上集計
      const staffRevenue = {};
      reservationsData.forEach(r => {
        const staffName = r.staffName || 'その他';
        staffRevenue[staffName] = (staffRevenue[staffName] || 0) + (r.price || 0);
      });

      const labels = Object.keys(staffRevenue);
      const data = Object.values(staffRevenue);

      if (charts.staff) charts.staff.destroy();

      charts.staff = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '売上',
            data: data,
            backgroundColor: 'rgba(34, 197, 94, 0.8)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '¥' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // 時間帯別予約数チャート
    function renderTimeChart() {
      const ctx = document.getElementById('timeChart').getContext('2d');
      
      // 時間帯別集計
      const hourlyData = new Array(24).fill(0);
      reservationsData.forEach(r => {
        const hour = r.datetime.getHours();
        hourlyData[hour]++;
      });

      const labels = Array.from({length: 24}, (_, i) => `${i}:00`);

      if (charts.time) charts.time.destroy();

      charts.time = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '予約数',
            data: hourlyData,
            backgroundColor: 'rgba(147, 51, 234, 0.8)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // スタッフパフォーマンスチャート
    function renderStaffPerformanceChart() {
      const ctx = document.getElementById('staffPerformanceChart').getContext('2d');
      
      // スタッフ別の予約数と売上
      const staffStats = {};
      reservationsData.forEach(r => {
        const staffName = r.staffName || 'その他';
        if (!staffStats[staffName]) {
          staffStats[staffName] = { count: 0, revenue: 0 };
        }
        staffStats[staffName].count++;
        staffStats[staffName].revenue += (r.price || 0);
      });

      const labels = Object.keys(staffStats);
      const countData = labels.map(name => staffStats[name].count);
      const revenueData = labels.map(name => staffStats[name].revenue);

      if (charts.staffPerformance) charts.staffPerformance.destroy();

      charts.staffPerformance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: '予約数',
              data: countData,
              backgroundColor: 'rgba(59, 130, 246, 0.8)',
              yAxisID: 'y'
            },
            {
              label: '売上',
              data: revenueData,
              backgroundColor: 'rgba(34, 197, 94, 0.8)',
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                callback: function(value) {
                  return '¥' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // 予約テーブル描画
    function renderReservationsTable() {
      const tbody = document.getElementById('reservationsTableBody');
      tbody.innerHTML = '';

      let filteredData = [...reservationsData];
      
      // フィルター適用
      const dateFilter = document.getElementById('reservationDateFilter').value;
      const statusFilter = document.getElementById('reservationStatusFilter').value;

      if (dateFilter) {
        const filterDate = new Date(dateFilter);
        filteredData = filteredData.filter(r => {
          const resDate = new Date(r.datetime.getFullYear(), r.datetime.getMonth(), r.datetime.getDate());
          const filterDateOnly = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate());
          return resDate.getTime() === filterDateOnly.getTime();
        });
      }

      if (statusFilter) {
        filteredData = filteredData.filter(r => r.status === statusFilter);
      }

      filteredData.forEach(reservation => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        const status = reservation.status || 'confirmed';
        const statusBadge = getStatusBadge(status);
        
        row.innerHTML = `
          <td class="px-4 py-2 text-sm">${reservation.datetime.toLocaleString('ja-JP')}</td>
          <td class="px-4 py-2 text-sm">${reservation.name || '-'}</td>
          <td class="px-4 py-2 text-sm">${reservation.menuName || '-'}</td>
          <td class="px-4 py-2 text-sm">${reservation.staffName || '-'}</td>
          <td class="px-4 py-2 text-sm">¥${(reservation.price || 0).toLocaleString()}</td>
          <td class="px-4 py-2 text-sm">${statusBadge}</td>
          <td class="px-4 py-2 text-sm">
            <button onclick="showReservationDetail('${reservation.id}')" 
                    class="text-blue-600 hover:text-blue-800 text-sm">詳細</button>
            <button onclick="cancelReservation('${reservation.id}')" 
                    class="ml-2 text-red-600 hover:text-red-800 text-sm">キャンセル</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // 顧客テーブル描画
    function renderCustomersTable() {
      const tbody = document.getElementById('customersTableBody');
      tbody.innerHTML = '';

      let filteredData = [...customersData];
      
      // フィルター適用
      const searchInput = document.getElementById('customerSearchInput').value.toLowerCase();
      const segmentFilter = document.getElementById('customerSegmentFilter').value;

      if (searchInput) {
        filteredData = filteredData.filter(c => 
          (c.name || '').toLowerCase().includes(searchInput)
        );
      }

      if (segmentFilter) {
        filteredData = filteredData.filter(c => c.segment === segmentFilter);
      }

      filteredData.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        const segmentBadge = getSegmentBadge(customer.segment);
        const lastVisitText = customer.lastVisit ? 
          customer.lastVisit.toLocaleDateString('ja-JP') : '-';
        
        row.innerHTML = `
          <td class="px-4 py-2 text-sm">${customer.name || '-'}</td>
          <td class="px-4 py-2 text-sm">${customer.phone || '-'}</td>
          <td class="px-4 py-2 text-sm">${customer.visitCount}</td>
          <td class="px-4 py-2 text-sm">${lastVisitText}</td>
          <td class="px-4 py-2 text-sm">¥${customer.totalAmount.toLocaleString()}</td>
          <td class="px-4 py-2 text-sm">${segmentBadge}</td>
          <td class="px-4 py-2 text-sm">
            <button onclick="showCustomerDetail('${customer.id}')" 
                    class="text-blue-600 hover:text-blue-800 text-sm">詳細</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // スタッフリスト描画
    function renderStaffList() {
      const container = document.getElementById('staffList');
      container.innerHTML = '';

      staffsData.forEach(staff => {
        // このスタッフの統計を計算
        const staffReservations = reservationsData.filter(r => r.staffId === staff.id);
        const staffRevenue = staffReservations.reduce((sum, r) => sum + (r.price || 0), 0);
        
        const card = document.createElement('div');
        card.className = 'bg-gray-50 rounded-lg p-4 mb-4';
        card.innerHTML = `
          <div class="flex items-center space-x-4">
            <img src="${staff.photoURL || 'https://dummyimage.com/60x60/cccccc/000000.png'}" 
                 alt="${staff.name}" 
                 class="w-12 h-12 rounded-full object-cover">
            <div class="flex-1">
              <h4 class="font-medium">${staff.name || '-'}</h4>
              <p class="text-sm text-gray-600">${staff.specialty || '-'}</p>
              <div class="flex space-x-4 mt-2 text-sm">
                <span>予約数: ${staffReservations.length}</span>
                <span>売上: ¥${staffRevenue.toLocaleString()}</span>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // ステータスバッジ
    function getStatusBadge(status) {
      const badges = {
        confirmed: '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">確定</span>',
        cancelled: '<span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">キャンセル</span>',
        completed: '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">完了</span>'
      };
      return badges[status] || badges.confirmed;
    }

    // セグメントバッジ
    function getSegmentBadge(segment) {
      const badges = {
        vip: '<span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded-full">VIP</span>',
        regular: '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">常連</span>',
        new: '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">新規</span>',
        inactive: '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-full">休眠</span>'
      };
      return badges[segment] || badges.regular;
    }

    // フィルター関数
    function filterReservations() {
      renderReservationsTable();
    }

    function filterCustomers() {
      renderCustomersTable();
    }

    // モーダル関数
    function showReservationDetail(reservationId) {
      const reservation = reservationsData.find(r => r.id === reservationId);
      if (!reservation) return;

      document.getElementById('modalTitle').textContent = '予約詳細';
      document.getElementById('modalContent').innerHTML = `
        <div class="space-y-4">
          <div><strong>予約ID:</strong> ${reservation.id}</div>
          <div><strong>顧客名:</strong> ${reservation.name}</div>
          <div><strong>メニュー:</strong> ${reservation.menuName}</div>
          <div><strong>スタッフ:</strong> ${reservation.staffName}</div>
          <div><strong>日時:</strong> ${reservation.datetime.toLocaleString('ja-JP')}</div>
          <div><strong>金額:</strong> ¥${(reservation.price || 0).toLocaleString()}</div>
          <div><strong>所要時間:</strong> ${reservation.duration || 0}分</div>
          <div><strong>メモ:</strong> ${reservation.note || '-'}</div>
        </div>
      `;
      showModal();
    }

    function showCustomerDetail(customerId) {
      const customer = customersData.find(c => c.id === customerId);
      if (!customer) return;

      const reservationHistory = (customer.reservations || [])
        .sort((a, b) => new Date(b.datetime) - new Date(a.datetime))
        .slice(0, 5)
        .map(r => `
          <div class="py-2 border-b">
            <div class="text-sm">${new Date(r.datetime).toLocaleDateString('ja-JP')} - ${r.menu}</div>
            <div class="text-xs text-gray-600">¥${(r.price || 0).toLocaleString()}</div>
          </div>
        `).join('');

      document.getElementById('modalTitle').textContent = '顧客詳細';
      document.getElementById('modalContent').innerHTML = `
        <div class="space-y-4">
          <div><strong>顧客名:</strong> ${customer.name}</div>
          <div><strong>電話番号:</strong> ${customer.phone || '-'}</div>
          <div><strong>来店回数:</strong> ${customer.visitCount}回</div>
          <div><strong>累計金額:</strong> ¥${customer.totalAmount.toLocaleString()}</div>
          <div><strong>最終来店:</strong> ${customer.lastVisit ? customer.lastVisit.toLocaleDateString('ja-JP') : '-'}</div>
          <div><strong>セグメント:</strong> ${getSegmentBadge(customer.segment)}</div>
          <div>
            <strong>来店履歴:</strong>
            <div class="mt-2 max-h-32 overflow-y-auto">
              ${reservationHistory || '<div class="text-sm text-gray-600">履歴なし</div>'}
            </div>
          </div>
        </div>
      `;
      showModal();
    }

    function showModal() {
      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.getElementById('modal').classList.remove('flex');
    }

    // 予約キャンセル
    async function cancelReservation(reservationId) {
      if (!confirm('この予約をキャンセルしますか？')) return;
      
      try {
        await db.collection('reservations').doc(reservationId).update({
          status: 'cancelled'
        });
        await loadReservations();
        updateMetrics();
        showSuccess('予約をキャンセルしました');
      } catch (error) {
        console.error('キャンセルエラー:', error);
        showError('キャンセルに失敗しました');
      }
    }

    // 通知表示
    function showSuccess(message) {
      // 簡易的な成功通知
      alert(message);
    }

    function showError(message) {
      // 簡易的なエラー通知
      alert(message);
    }

    // ウィンドウの予約キャンセル関数をグローバルに公開
    window.cancelReservation = cancelReservation;
    window.showReservationDetail = showReservationDetail;
    window.showCustomerDetail = showCustomerDetail;
  </script>
</body>
</html>