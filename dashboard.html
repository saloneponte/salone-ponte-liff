<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>予約ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 8px; }
    th { background-color: #f0f0f0; }
    button { padding: 4px 8px; }
  </style>
</head>
<body>
  <h2>予約ダッシュボード</h2>
  <label>店舗ID: <input type="text" id="shopFilter" placeholder="例: a" /></label>
  <button onclick="loadReservations()">読み込み</button>
  <button onclick="downloadCSV()">CSV出力</button>
  <br><br>
  <table id="reservationsTable">
    <thead>
      <tr>
        <th>名前</th><th>電話</th><th>メニュー</th><th>日時</th><th>ステータス</th><th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAK14FMyp7VGYZPakGDmLdgHsvvxT-b0TM",
      authDomain: "salone-ponte-fceca.firebaseapp.com",
      projectId: "salone-ponte-fceca",
      storageBucket: "salone-ponte-fceca.firebasestorage.app",
      messagingSenderId: "463711728652",
      appId: "1:463711728652:web:59c749e11d201b26b86a29",
      measurementId: "G-MPWGTB6R7C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.loadReservations = async () => {
      const tbody = document.querySelector("#reservationsTable tbody");
      tbody.innerHTML = "";

      const shopId = document.getElementById("shopFilter").value.trim();
      const q = shopId ? query(collection(db, "reservations"), where("shopId", "==", shopId)) : collection(db, "reservations");
      const snapshot = await getDocs(q);

      const rows = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        rows.push({ id: docSnap.id, ...data });
      });

      rows.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.phone}</td>
          <td>${r.menu}</td>
          <td>${new Date(r.datetime).toLocaleString()}</td>
          <td>${r.status || "pending"}</td>
          <td><button onclick="markDone('${r.id}')">完了</button></td>
        `;
        tbody.appendChild(tr);
      }
    };

    window.markDone = async (id) => {
      const ref = doc(db, "reservations", id);
      await updateDoc(ref, { status: "done" });
      loadReservations();
    };

    window.downloadCSV = () => {
      const rows = document.querySelectorAll("#reservationsTable tr");
      let csv = "";
      rows.forEach(row => {
        const cols = row.querySelectorAll("td, th");
        const rowText = Array.from(cols).map(col => `"${col.innerText}"`).join(",");
        csv += rowText + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "reservations.csv";
      a.click();
    };
  </script>
</body>
</html>
