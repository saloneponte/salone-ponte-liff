<!-- index.html – 週ナビゲーション付きカレンダー（修正版） -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Salone Ponte 予約フォーム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:sans-serif;padding:10px}
    .nav{display:flex;justify-content:space-between;margin:10px 0}
    .nav button{padding:4px 10px;border:1px solid #ccc;background:#f0f0f0;cursor:pointer;border-radius:4px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ccc;padding:6px;text-align:center}
    th{background:#f0f0f0;font-size:12px}
    .available{background:#cce5ff;cursor:pointer}.available:hover{background:#99ccff}
    .unavailable{background:#f8d7da;color:#721c24}
    .selected{background:#007bff;color:#fff}
    .submit{width:100%;padding:10px;background:#28a745;color:#fff;border:none;border-radius:4px;margin-top:15px;font-size:16px}
  </style>
</head>
<body>
  <label>お名前：
    <input id="userNameInput" type="text" placeholder="例）佐藤花子">
  </label><br>
  <label>電話番号：
    <input id="userPhoneInput" type="tel" placeholder="例）09012345678">
  </label><br>

  <h2>ご予約カレンダー</h2>
  <label>メニュー:
    <select id="menu">
      <option value="cut">カット</option>
      <option value="color">カラー</option>
      <option value="perm">パーマ</option>
    </select>
  </label>

  <div class="nav">
    <button id="prevWeek">&lt; 前週</button>
    <div id="weekLabel"></div>
    <button id="nextWeek">次週 &gt;</button>
  </div>

  <table id="calendar">
    <thead id="calendar-head"></thead>
    <tbody id="calendar-body"></tbody>
  </table>
  <button id="reserveBtn" class="submit" style="display:none">この内容で予約する</button>

  <!-- SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    /* ---------- 初期設定 ---------- */
    const firebaseConfig = { apiKey:"AIzaSyAK14FMyp7VGYZPakGDmLdgHsvvxT-b0TM", projectId:"salone-ponte-fceca" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const durations = { cut:60, color:90, perm:120 };
    const times = [];
    for(let h=10; h<=17; h++){ for(let m=0; m<60; m+=30){ times.push(`${String(h).padStart(2,'0')}:${m===0?'00':'30'}`);} }

    let offsetWeeks = 0, selDate=null, userId="", userName="";
    const weekLabel = document.getElementById('weekLabel');
    const head  = document.getElementById('calendar-head');
    const body  = document.getElementById('calendar-body');
    const menuSel = document.getElementById('menu');
    const btn  = document.getElementById('reserveBtn');

    /* ---------- ① カレンダー描画関数 ---------- */
    async function renderCalendar(){
      body.innerHTML = ''; head.innerHTML = ''; btn.style.display='none'; selDate=null;

      const startWeek = new Date(); startWeek.setDate(startWeek.getDate()+offsetWeeks*7);
      const endWeek   = new Date(startWeek); endWeek.setDate(endWeek.getDate()+6);
      weekLabel.textContent = `${formatDate(startWeek)} - ${formatDate(endWeek)}`;

      // ヘッダー（日付＋曜日）
      const hr = document.createElement('tr'); hr.innerHTML = '<th>時間</th>';
      for(let i=0;i<7;i++){ const d=new Date(startWeek); d.setDate(startWeek.getDate()+i); hr.innerHTML+=`<th>${formatDate(d)}</th>`;}
      head.appendChild(hr);

      // 1週間分の既存予約を取得
      const weekStartISO = startWeek.toISOString();
      const weekEndISO   = new Date(endWeek.getFullYear(), endWeek.getMonth(), endWeek.getDate(), 23,59,59).toISOString();
      const snap = await db.collection('reservations')
                           .where('datetime','>=',weekStartISO)
                           .where('datetime','<=',weekEndISO).get();

      const reserved = [];
      snap.forEach(doc=>{
        const d = doc.data();
        const st=new Date(d.datetime);
        const en=new Date(st.getTime()+(durations[d.menu]||60)*60000);
        reserved.push({st,en});
      });

      const dur = durations[menuSel.value];
      times.forEach(t=>{
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${t}</td>`;
        for(let i=0;i<7;i++){
          const cell=document.createElement('td');
          const d = new Date(startWeek); d.setDate(startWeek.getDate()+i);
          const [hh,mm] = t.split(':'); d.setHours(+hh,+mm,0,0);
          const end = new Date(d.getTime()+dur*60000);
          const overlap = reserved.some(r=> d<r.en && end>r.st);

          if(overlap){
            cell.textContent='×'; cell.className='unavailable';
          }else{
            cell.textContent='◯'; cell.className='available';
            cell.onclick=()=>{ document.querySelectorAll('.selected').forEach(c=>c.classList.remove('selected'));
              cell.classList.add('selected'); selDate=new Date(d); btn.style.display='block'; };
          }
          tr.appendChild(cell);
        }
        body.appendChild(tr);
      });
    }

    function formatDate(d){ return `${d.getMonth()+1}/${d.getDate()}(${"日月火水木金土"[d.getDay()]})`; }

    /* ---------- ② イベント登録 ---------- */
    document.getElementById('prevWeek').onclick = ()=>{ offsetWeeks--; renderCalendar(); };
    document.getElementById('nextWeek').onclick = ()=>{ offsetWeeks++; renderCalendar(); };
    menuSel.onchange = renderCalendar;

    /* ---------- ③ 予約ボタンクリック ---------- */
    btn.onclick = async () => {
      if(!selDate) return;
      const nameInput  = document.getElementById('userNameInput').value.trim() || userName;
      const phoneInput = document.getElementById('userPhoneInput').value.trim() || "";

      const data = {
        userId, name:nameInput, phone:phoneInput,
        menu:menuSel.value,
        datetime: selDate.toISOString(),
        createdAt: new Date().toISOString()
      };

      try{
        await db.collection('reservations').add(data);

        const custRef = db.collection('customers').doc(userId);
        const snap    = await custRef.get();
        if(snap.exists){
          const arr = snap.data().reservations || [];
          arr.push({ menu:data.menu, datetime:data.datetime });
          await custRef.update({ name:nameInput, phone:phoneInput, reservations:arr });
        }else{
          await custRef.set({ userId, name:nameInput, phone:phoneInput,
                              reservations:[{ menu:data.menu, datetime:data.datetime }] });
        }
        alert('予約を受け付けました');
        renderCalendar();
      }catch(e){
        alert('予約保存に失敗しました：'+e.message);
      }
    };

    /* ---------- ④ LIFF 初期化後にカレンダー描画 ---------- */
    window.onload = async () => {
      await liff.init({ liffId:'2007345180-oVA2L6dw' });
      if(!liff.isLoggedIn()) return liff.login();
      const p = await liff.getProfile();
      userId = p.userId; userName = p.displayName;
      renderCalendar();
    };
  </script>
</body>
</html>
