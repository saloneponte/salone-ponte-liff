<!-- index.html – 週ナビゲーション付きカレンダー -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Salone Ponte 予約フォーム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:sans-serif;padding:10px}
    .nav{display:flex;justify-content:space-between;margin:10px 0}
    .nav button{padding:4px 10px;border:1px solid #ccc;background:#f0f0f0;cursor:pointer;border-radius:4px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ccc;padding:6px;text-align:center}
    th{background:#f0f0f0;font-size:12px}
    .available{background:#cce5ff;cursor:pointer}.available:hover{background:#99ccff}
    .unavailable{background:#f8d7da;color:#721c24}
    .selected{background:#007bff;color:#fff}
    .submit{width:100%;padding:10px;background:#28a745;color:#fff;border:none;border-radius:4px;margin-top:15px;font-size:16px}
  </style>
</head>
<body>
    <label>お名前：<input id="userNameInput" type="text" placeholder="例）佐藤花子"></label><br>
<label>電話番号：<input id="userPhoneInput" type="tel" placeholder="例）09012345678"></label><br>

  <h2>ご予約カレンダー</h2>
  <label>メニュー:
    <select id="menu">
      <option value="cut">カット</option>
      <option value="color">カラー</option>
      <option value="perm">パーマ</option>
    </select>
  </label>

  <div class="nav">
    <button id="prevWeek">&lt; 前週</button>
    <div id="weekLabel"></div>
    <button id="nextWeek">次週 &gt;</button>
  </div>

  <table id="calendar">
    <thead id="calendar-head"></thead>
    <tbody id="calendar-body"></tbody>
  </table>
  <button id="reserveBtn" class="submit" style="display:none">この内容で予約する</button>

  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig={apiKey:"AIzaSyAK14FMyp7VGYZPakGDmLdgHsvvxT-b0TM",projectId:"salone-ponte-fceca"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    const durations={cut:60,color:90,perm:120};
    const times=[];for(let h=10;h<=17;h++){for(let m=0;m<60;m+=30){times.push(`${String(h).padStart(2,'0')}:${m===0?'00':'30'}`);}}

    let offsetWeeks=0,selDate=null,selTime=null,userId="",userName="";
    const weekLabel=document.getElementById('weekLabel');
    const head=document.getElementById('calendar-head');
    const body=document.getElementById('calendar-body');
    const menuSel=document.getElementById('menu');
    const btn=document.getElementById('reserveBtn');

    document.getElementById('prevWeek').onclick=()=>{offsetWeeks--;renderCalendar();};
    document.getElementById('nextWeek').onclick=()=>{offsetWeeks++;renderCalendar();};
    menuSel.onchange=renderCalendar;

    function getStartOfWeek(){const d=new Date();d.setDate(d.getDate()+offsetWeeks*7);return d;}
    function formatDate(d){return `${d.getMonth()+1}/${d.getDate()}(${"日月火水木金土"[d.getDay()]})`;}

    async function renderCustomers() {
  const tbody = document.getElementById('customer-body');
  tbody.innerHTML = '';
  const snap = await db.collection('customers').orderBy('name').get();

  snap.forEach(doc => {
    const c = doc.data();
    const last = c.reservations?.slice(-1)[0];       // 最新来店
    const tr  = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.name}</td>
      <td>${c.phone || '-'}</td>
      <td>${last ? new Date(last.datetime).toLocaleDateString() : '-'}</td>
      <td>${last ? last.menu : '-'}</td>
      <td><button data-id="${doc.id}">詳細</button></td>`;
    tbody.appendChild(tr);
  });
}


    btn.onclick = async () => {
  // ---- ① 入力値を取得 ----
  const nameInput  = document.getElementById('userNameInput').value.trim() || userName;
  const phoneInput = document.getElementById('userPhoneInput').value.trim() || "";

  if (!selDate) return;              // 日時が未選択なら何もしない

  // ---- ② 保存する予約データ ----
  const data = {
    userId,
    name:  nameInput,
    phone: phoneInput,
    menu:  menuSel.value,
    datetime: selDate.toISOString(),
    createdAt: new Date().toISOString()
  };

  try {
    // ---- ③ reservations に追加 ----
    await db.collection('reservations').add(data);

    // ---- ④ customers を作成 / 更新 ----
    const custRef = db.collection('customers').doc(userId);
    const snap    = await custRef.get();

    if (snap.exists) {
      const arr = snap.data().reservations || [];
      arr.push({ menu: data.menu, datetime: data.datetime });

      await custRef.update({
        name:  nameInput,
        phone: phoneInput,
        reservations: arr
      });
    } else {
      await custRef.set({
        userId,
        name:  nameInput,
        phone: phoneInput,
        reservations: [
          { menu: data.menu, datetime: data.datetime }
        ]
      });
    }

    alert('予約を受け付けました');
    renderCalendar();                // カレンダーを再描画（枠を×にする）
  } catch (e) {
    alert('予約保存に失敗しました：' + e.message);
  }
};


    // LIFF init
    (async()=>{await liff.init({liffId:'2007345180-oVA2L6dw'});if(!liff.isLoggedIn())return liff.login();const p=await liff.getProfile();userId=p.userId;userName=p.displayName;renderCalendar();})();
  </script>
</body>
</html>
