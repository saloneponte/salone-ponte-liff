<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Salone Ponte 予約フロー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ======= 全体スタイル ======= */
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 10px;
    }
    h2 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 20px;
      text-align: center;
    }
    button {
      cursor: pointer;
    }

    /* ======= 画面セクション ======= */
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }

    /* ======= メニューカード ======= */
    .menus-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .menu-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      transition: box-shadow 0.2s;
    }
    .menu-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .menu-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
    }
    .menu-info {
      padding: 8px;
    }
    .menu-info h3 {
      margin: 6px 0 4px;
      font-size: 16px;
    }
    .menu-info p {
      margin: 2px 0;
      font-size: 14px;
    }
    .menu-select-btn {
      margin-top: 6px;
      padding: 6px 12px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
    .menu-select-btn:hover {
      background: #0056b3;
    }

    /* ======= カレンダー ======= */
    .nav {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
    }
    .nav button {
      padding: 4px 8px;
      border: 1px solid #ccc;
      background: #f0f0f0;
      cursor: pointer;
      border-radius: 4px;
    }
    .nav button:hover {
      background: #ddd;
    }
    .calendar-wrapper {
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      font-size: 12px;
      white-space: nowrap;
    }
    th {
      background: #f0f0f0;
    }
    .available {
      background: #cce5ff;
      cursor: pointer;
    }
    .available:hover {
      background: #99ccff;
    }
    .unavailable {
      background: #f8d7da;
      color: #721c24;
    }
    .selected {
      background: #007bff;
      color: #fff;
    }

    /* ======= フォーム入力 ======= */
    .form-group {
      margin-bottom: 12px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    .form-group input[type="text"],
    .form-group input[type="tel"],
    .form-group textarea,
    .form-group select,
    .form-group input[type="datetime-local"] {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }
    .btn-submit {
      width: 100%;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px 0;
      font-size: 16px;
      margin-top: 10px;
    }
    .btn-submit:hover {
      background: #218838;
    }

    /* ======= スタッフ選択 ======= */
    .staff-select {
      margin: 10px 0;
    }
    .staff-select select {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .staff-profile {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      margin-bottom: 10px;
    }
    .staff-profile img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .staff-profile .info {
      font-size: 14px;
    }
    .staff-profile .info h4 {
      margin: 4px 0;
      font-size: 16px;
    }
    .staff-profile .info p {
      margin: 2px 0;
      color: #555;
    }

    /* ======= モバイル調整 ======= */
    @media screen and (max-width: 480px) {
      .menu-info h3 {
        font-size: 14px;
      }
      .menu-info p {
        font-size: 12px;
      }
      .nav button {
        font-size: 12px;
        padding: 4px 6px;
      }
      th, td {
        font-size: 10px;
        padding: 4px;
      }
      .btn-submit {
        font-size: 14px;
        padding: 8px 0;
      }
      .staff-profile {
        flex-direction: column;
        align-items: flex-start;
      }
      .staff-profile img {
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Salone Ponte 予約</h2>

    <!-- ========== 1. メニュー選択画面 ========== -->
    <div id="menuView" class="view active">
      <h2>メニューを選択</h2>
      <div id="menusContainer" class="menus-grid">
        <!-- Firestore の menus コレクションから取得してカードを生成 -->
      </div>
    </div>

    <!-- ========== 2. 担当者＋カレンダー選択画面 ========== -->
    <div id="calendarView" class="view">
      <h2>担当者と日時を選択</h2>

      <!-- 選択中メニュー情報表示 -->
      <div id="selectedMenuInfo" style="text-align:center; margin-bottom:10px;">
        <!-- 例：<strong>カット</strong> - ¥4,000 (所要60分) -->
      </div>

      <!-- スタッフ選択 -->
      <div class="staff-select">
        <label for="staffSelect">担当者：</label>
        <select id="staffSelect"></select>
      </div>

      <!-- スタッフプロフィール表示 -->
      <div id="staffProfile" class="staff-profile" style="display:none;">
        <!-- placeholder の URL を dummyimage.com に変更 -->
        <img id="staffPhoto" src="" alt="スタッフ写真"
             onerror="this.src='https://dummyimage.com/60x60/cccccc/000000.png';" />
        <div class="info">
          <h4 id="staffName"></h4>
          <p id="staffSpecialty"></p>
        </div>
      </div>

      <!-- 週ナビゲーション付きカレンダー -->
      <div class="nav">
        <button id="prevWeekBtn">&lt; 前週</button>
        <div id="weekLabel"></div>
        <button id="nextWeekBtn">次週 &gt;</button>
      </div>
      <div class="calendar-wrapper">
        <table>
          <thead id="calendarHead"></thead>
          <tbody id="calendarBody"></tbody>
        </table>
      </div>

      <button id="toDetailBtn" class="btn-submit" style="display:none; margin-top:10px;">
        次へ
      </button>
      <button id="backToMenuBtn" class="btn-submit" style="background:#6c757d; margin-top:6px;">
        戻る
      </button>
    </div>

    <!-- ========== 3. 詳細入力画面 ========== -->
    <div id="detailView" class="view">
      <h2>予約情報を入力</h2>

      <!-- 既存顧客かどうか判定中メッセージ -->
      <div id="detailLoading" style="text-align:center; margin-bottom:10px;">
        読み込み中...
      </div>

      <form id="detailForm" style="display:none;">
        <!-- 初回予約：名前・電話入力欄 -->
        <div id="firstTimeFields">
          <div class="form-group">
            <label for="custNameInput">お名前</label>
            <!-- name 属性を追加 -->
            <input type="text" id="custNameInput" name="custName" required />
          </div>
          <div class="form-group">
            <label for="custPhoneInput">電話番号</label>
            <input type="tel"  id="custPhoneInput" name="custPhone" required />
          </div>
        </div>

        <!-- 気になる点・メモ（全員表示） -->
        <div class="form-group">
          <label for="custNoteInput">気になる点・メモ（任意）</label>
          <textarea id="custNoteInput" placeholder="アレルギー等あればご記入ください"></textarea>
        </div>

        <button type="submit" class="btn-submit">予約を確定</button>
        <button type="button" id="backToCalendarBtn" class="btn-submit"
                style="background:#6c757d; margin-top:6px;">
          戻る
        </button>
      </form>
    </div>
  </div>

  <!-- Firestore & LIFF SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

  <script>
    // ================= Firebase 初期化 =================
    const firebaseConfig = {
      apiKey:    "AIzaSyAK14FMyp7VGYZPakGDmLdgHsvvxT-b0TM",
      authDomain: "salone-ponte-fceca.firebaseapp.com",
      projectId: "salone-ponte-fceca",
      storageBucket: "salone-ponte-fceca.appspot.com",
      messagingSenderId: "463711728652",
      appId:     "1:463711728652:web:59c749e11d201b26b86a29",
      measurementId: "G-MPWGTB6R7C"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ================= グローバル変数 =================
    let userId = "", userName = "";             // LIFFログインで取得
    let menusData = [];                         // Firestore ― menus コレクション
    let staffsData = [];                        // Firestore ― staffs コレクション

    let selectedMenu = null;                    // { id, name, photoURL, price, duration }
    let selectedStaff = null;                   // { id, name, photoURL, specialty }
    let selDateObj = null;                      // Date 型の予約日時

    let offsetWeeks = 0;                        // カレンダーの週オフセット

    // ================= ビュー切り替えヘルパー =================
    function showView(viewId) {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.getElementById(viewId).classList.add("active");
    }

    // ================= 1. メニュー選択画面 =================
    async function loadMenus() {
      const container = document.getElementById("menusContainer");
      container.innerHTML = "";
      try {
        const snap = await db.collection("menus").get();
        menusData = [];
        snap.forEach(doc => {
          const d = doc.data();
          menusData.push({
            id:       doc.id,
            name:     d.name || "無名メニュー",
            photoURL: d.photoURL || "",
            price:    d.price || 0,
            duration: d.duration || 60
          });
        });

        if (menusData.length === 0) {
          container.innerHTML = "<p>まだメニューが登録されていません。</p>";
          return;
        }
        menusData.forEach(menu => {
          const card = document.createElement("div");
          card.className = "menu-card";
          card.innerHTML = `
            <img src="${menu.photoURL}" alt="${menu.name}"
                 onerror="this.src='https://dummyimage.com/150x100/cccccc/000000.png';" />
            <div class="menu-info">
              <h3>${menu.name}</h3>
              <p>¥${menu.price.toLocaleString()}</p>
              <p>所要 ${menu.duration} 分</p>
              <button class="menu-select-btn" data-id="${menu.id}">選択する</button>
            </div>
          `;
          container.appendChild(card);

          card.querySelector(".menu-select-btn").onclick = () => {
            console.log("メニューが選択されました:", menu);
            selectMenu(menu);
          };
        });
      } catch (err) {
        console.error("メニュー読み込みエラー:", err);
        container.innerHTML = `<p style="color:red;">メニュー読み込みに失敗しました。</p>`;
      }
    }

    function selectMenu(menu) {
      selectedMenu = menu;
      const infoDiv = document.getElementById("selectedMenuInfo");
      infoDiv.innerHTML = `
        <strong>${menu.name}</strong><br>
        ¥${menu.price.toLocaleString()}（所要 ${menu.duration} 分）
      `;
      loadStaffsAndShowCalendar();
    }

    // ================= 2. スタッフ＋カレンダー画面 =================
    async function loadStaffsAndShowCalendar() {
      showView("calendarView");

      // staffs コレクション取得
      try {
        const snap = await db.collection("staffs").get();
        staffsData = [];
        snap.forEach(doc => {
          const d = doc.data();
          staffsData.push({
            id:        doc.id,
            name:      d.name || "スタッフ",
            photoURL:  d.photoURL || "",
            specialty: d.specialty || ""
          });
        });
      } catch (err) {
        alert("スタッフ読み込みに失敗しました: " + err.message);
      }

      // プルダウン生成
      const sel = document.getElementById("staffSelect");
      sel.innerHTML = "<option value=\"\">-- 担当者を選択 --</option>";
      staffsData.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name;
        sel.appendChild(opt);
      });
      sel.onchange = () => {
        const sid = sel.value;
        selectedStaff = staffsData.find(x => x.id === sid) || null;
        console.log("選択されたスタッフ:", selectedStaff);
        renderStaffProfile();
        offsetWeeks = 0;
        renderCalendar();
      };

      // 「戻る」ボタン
      document.getElementById("backToMenuBtn").onclick = () => {
        showView("menuView");
      };

      // 週ナビボタン
      document.getElementById("prevWeekBtn").onclick = () => {
        offsetWeeks--;
        renderCalendar();
      };
      document.getElementById("nextWeekBtn").onclick = () => {
        offsetWeeks++;
        renderCalendar();
      };

      // 「次へ」ボタン
      document.getElementById("toDetailBtn").onclick = () => {
        console.log("「次へ」ボタン押下時の selDateObj:", selDateObj);
        if (!selDateObj) {
          alert("日時を選択してください");
          return;
        }
        loadDetailView();
      };

      // 初期状態
      selectedStaff = null;
      renderStaffProfile();
      clearCalendarTable();
    }

    function renderStaffProfile() {
      const profDiv = document.getElementById("staffProfile");
      if (!selectedStaff) {
        profDiv.style.display = "none";
        return;
      }
      document.getElementById("staffPhoto").src =
        selectedStaff.photoURL || "https://dummyimage.com/60x60/cccccc/000000.png";
      document.getElementById("staffName").textContent = selectedStaff.name;
      document.getElementById("staffSpecialty").textContent = selectedStaff.specialty;
      profDiv.style.display = "flex";
    }

    function clearCalendarTable() {
      document.getElementById("calendarHead").innerHTML = "";
      document.getElementById("calendarBody").innerHTML = "";
      document.getElementById("weekLabel").textContent = "";
      document.getElementById("toDetailBtn").style.display = "none";
      selDateObj = null;
    }

    async function renderCalendar() {
      const head = document.getElementById("calendarHead");
      const body = document.getElementById("calendarBody");
      head.innerHTML = "";
      body.innerHTML = "";
      document.getElementById("toDetailBtn").style.display = "none";
      selDateObj = null;

      if (!selectedStaff) {
        clearCalendarTable();
        return;
      }

      const today = new Date();
      const startWeek = new Date(today);
      startWeek.setDate(today.getDate() + offsetWeeks * 7);
      const endWeek = new Date(startWeek);
      endWeek.setDate(startWeek.getDate() + 6);

      const hr = document.createElement("tr");
      hr.innerHTML = "<th>時間</th>";
      for (let i = 0; i < 7; i++) {
        const d = new Date(startWeek);
        d.setDate(startWeek.getDate() + i);
        hr.innerHTML += `<th>${formatDate(d)}</th>`;
      }
      head.appendChild(hr);

      // Firestore の複合クエリ (staffId & datetime) → インデックスが必要
      let reserved = [];
      try {
        const weekStartISO = startWeek.toISOString();
        const weekEndISO = new Date(endWeek.getFullYear(), endWeek.getMonth(), endWeek.getDate(), 23,59,59).toISOString();
        console.log("予約取得クエリ → staffId:", selectedStaff.id,
                    ", datetime >=", weekStartISO,
                    ", <=", weekEndISO);
        const snap = await db.collection("reservations")
          .where("datetime", ">=", weekStartISO)
          .where("datetime", "<=", weekEndISO)
          .where("staffId", "==", selectedStaff.id)
          .get();

        reserved = [];
        snap.forEach(doc => {
          const d = doc.data();
          const st = new Date(d.datetime);
          const en = new Date(st.getTime() + (selectedMenu.duration || 60) * 60000);
          reserved.push({ st, en });
        });
        console.log("取得した予約データ数:", reserved.length);
      } catch (err) {
        console.error("予約取得エラー:", err);
        // インデックス未作成の段階ではこのタイミングでエラー出続けます。
        // → Firebase コンソールでインデックス作成後、再度ここが通るようになります。
      }

      const times = [];
      for (let h = 10; h <= 17; h++) {
        for (let m = 0; m < 60; m += 30) {
          times.push(`${String(h).padStart(2,"0")}:${m===0?"00":"30"}`);
        }
      }

      times.forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${t}</td>`;
        for (let i = 0; i < 7; i++) {
          const cell = document.createElement("td");
          const d = new Date(startWeek);
          d.setDate(startWeek.getDate() + i);
          const [hh, mm] = t.split(":");
          d.setHours(+hh, +mm, 0, 0);
          const end = new Date(d.getTime() + (selectedMenu.duration || 60) * 60000);

          const overlap = reserved.some(r => d < r.en && end > r.st);
          if (overlap) {
            cell.textContent = "×";
            cell.className = "unavailable";
          } else {
            cell.textContent = "◯";
            cell.className = "available";
            cell.onclick = () => {
              console.log("セルクリック: 日時 =>", d.toISOString());
              document.querySelectorAll(".selected").forEach(c => c.classList.remove("selected"));
              cell.classList.add("selected");
              selDateObj = new Date(d);
              document.getElementById("toDetailBtn").style.display = "block";
            };
          }
          tr.appendChild(cell);
        }
        body.appendChild(tr);
      });

      document.getElementById("weekLabel").textContent =
        `${formatDate(startWeek)} - ${formatDate(endWeek)}`;
    }

    function formatDate(d) {
      const w = ["日","月","火","水","木","金","土"][d.getDay()];
      return `${d.getMonth()+1}/${d.getDate()}(${w})`;
    }

    // ================= 3. 詳細入力画面 =================
    async function loadDetailView() {
      showView("detailView");
      document.getElementById("detailLoading").style.display = "block";
      document.getElementById("detailForm").style.display = "none";

      // LIFF 初期化とログイン
      try {
        await liff.init({ liffId: "2007345180-oVA2L6dw" });
        if (!liff.isLoggedIn()) {
          await liff.login();
          return;
        }
        const profile = await liff.getProfile();
        userId = profile.userId;
        userName = profile.displayName;
        console.log("LIFFログイン済み:", userId, userName);
      } catch (err) {
        alert("LINEログインエラー: " + err.message);
        return;
      }

      // Firestore の customers/{userId} 存在チェック
      let exists = false;
      try {
        const doc = await db.collection("customers").doc(userId).get();
        if (doc.exists) exists = true;
        console.log("顧客存在チェック:", exists);
      } catch (err) {
        alert("顧客チェック失敗: " + err.message);
      }

      // 既存顧客の場合は名前・電話欄を隠す
      const firstFields = document.getElementById("firstTimeFields");
      if (exists) {
        firstFields.style.display = "none";
      } else {
        firstFields.style.display = "block";
      }

      document.getElementById("detailLoading").style.display = "none";
      document.getElementById("detailForm").style.display = "block";
    }

    document.getElementById("backToCalendarBtn").onclick = () => {
      showView("calendarView");
    };

    document.getElementById("detailForm").onsubmit = async (e) => {
      e.preventDefault();
      console.log("detailForm onsubmit 発火");

      const note = document.getElementById("custNoteInput").value.trim();

      let nameVal = userName, phoneVal = "";
      if (document.getElementById("firstTimeFields").style.display !== "none") {
        nameVal = document.getElementById("custNameInput").value.trim();
        phoneVal = document.getElementById("custPhoneInput").value.trim();
        if (!nameVal || !phoneVal) {
          alert("お名前と電話番号を入力してください");
          return;
        }
      }

      const data = {
        userId,
        name:       nameVal,
        phone:      phoneVal,
        menuId:     selectedMenu.id,
        menuName:   selectedMenu.name,
        price:      selectedMenu.price,
        duration:   selectedMenu.duration,
        staffId:    selectedStaff.id,
        staffName:  selectedStaff.name,
        datetime:   selDateObj.toISOString(),
        note:       note,
        createdAt:  new Date().toISOString()
      };

      console.log("Firestore に保存するデータ:", data);
      try {
        const resRef = await db.collection("reservations").add(data);
        console.log("reservations ドキュメント追加成功:", resRef.id);

        const custRef = db.collection("customers").doc(userId);
        const snap    = await custRef.get();
        if (snap.exists) {
          const arr = snap.data().reservations || [];
          arr.push({
            menu:     selectedMenu.name,
            datetime: selDateObj.toISOString(),
            staff:    selectedStaff.name,
            price:    selectedMenu.price
          });
          await custRef.update({ reservations: arr });
          console.log("customers ドキュメントを更新");
        } else {
          await custRef.set({
            userId,
            name:  nameVal,
            phone: phoneVal,
            reservations: [
              {
                menu:     selectedMenu.name,
                datetime: selDateObj.toISOString(),
                staff:    selectedStaff.name,
                price:    selectedMenu.price
              }
            ]
          });
          console.log("customers ドキュメントを新規作成");
        }

        alert("予約が確定しました！");
        window.location.reload();
      } catch (err) {
        console.error("Firestore 書き込みエラー:", err);
        alert("予約登録に失敗しました: " + err.message);
      }
    };

    // ================= 初回ロード =================
    window.onload = () => {
      showView("menuView");
      loadMenus();
    };
  </script>
</body>
</html>
