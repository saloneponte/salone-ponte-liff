<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>é¡§å®¢ç®¡ç† - Salone Ponte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/src/styles/tailwind-compiled.css" rel="stylesheet">
  <style>
    .tag {
      @apply inline-block px-2 py-1 text-xs rounded-full;
    }
    .tag-vip { @apply bg-purple-100 text-purple-800; }
    .tag-regular { @apply bg-green-100 text-green-800; }
    .tag-new { @apply bg-blue-100 text-blue-800; }
    .tag-risk { @apply bg-red-100 text-red-800; }
    .tag-custom { @apply bg-gray-100 text-gray-800; }
    
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    
    .photo-item {
      aspect-ratio: 1;
      background: #f3f4f6;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }
    
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .modal {
      @apply fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50;
    }
    
    .modal.active {
      @apply flex;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <div class="flex items-center gap-4 mb-2">
          <button onclick="history.back()" class="text-gray-500 hover:text-gray-700">
            â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
          </button>
        </div>
        <h1 class="text-3xl font-bold text-gray-800">ğŸ‘¥ é¡§å®¢ç®¡ç†</h1>
        <p class="text-gray-600">ã‚«ãƒ«ãƒ†ãƒ»ã‚¿ã‚°ãƒ»æ–½è¡“å±¥æ­´ç®¡ç†</p>
      </div>
      <div class="flex space-x-3">
        <button id="addCustomerBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
          + æ–°è¦é¡§å®¢è¿½åŠ 
        </button>
        <button id="exportBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
          ğŸ“Š CSVå‡ºåŠ›
        </button>
      </div>
    </div>

    <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">é¡§å®¢æ¤œç´¢</label>
          <input type="text" id="searchInput" placeholder="åå‰ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿</label>
          <select id="tagFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">å…¨ã¦</option>
            <option value="VIPé¡§å®¢">VIPé¡§å®¢</option>
            <option value="å¸¸é€£é¡§å®¢">å¸¸é€£é¡§å®¢</option>
            <option value="æ–°è¦é¡§å®¢">æ–°è¦é¡§å®¢</option>
            <option value="é›¢åãƒªã‚¹ã‚¯">é›¢åãƒªã‚¹ã‚¯</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">æ¥åº—æœŸé–“</label>
          <select id="visitFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">å…¨æœŸé–“</option>
            <option value="30">30æ—¥ä»¥å†…</option>
            <option value="60">60æ—¥ä»¥å†…</option>
            <option value="90">90æ—¥ä»¥å†…</option>
            <option value="180">180æ—¥ä»¥ä¸Š</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="resetFilter" class="w-full bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors">
            ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
      </div>
    </div>

    <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-blue-100 text-blue-600">
            ğŸ‘¥
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">ç·é¡§å®¢æ•°</p>
            <p class="text-2xl font-semibold text-gray-900" id="totalCustomers">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-green-100 text-green-600">
            ğŸ”„
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">ä»Šæœˆæ–°è¦</p>
            <p class="text-2xl font-semibold text-gray-900" id="newCustomers">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-purple-100 text-purple-600">
            ğŸ’
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">VIPé¡§å®¢</p>
            <p class="text-2xl font-semibold text-gray-900" id="vipCustomers">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-red-100 text-red-600">
            âš ï¸
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">é›¢åãƒªã‚¹ã‚¯</p>
            <p class="text-2xl font-semibold text-gray-900" id="riskCustomers">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- é¡§å®¢ä¸€è¦§ -->
    <div class="bg-white rounded-lg shadow-md">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">é¡§å®¢ä¸€è¦§</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¡§å®¢æƒ…å ±</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ã‚¿ã‚°</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¥åº—æƒ…å ±</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç´¯è¨ˆé‡‘é¡</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€çµ‚æ¥åº—</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="customerTable" class="bg-white divide-y divide-gray-200">
            <!-- é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ã‚«ãƒ«ãƒ†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="customerModal" class="modal">
    <div class="bg-white rounded-lg w-full max-w-4xl mx-4 max-h-full overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900" id="modalCustomerName">é¡§å®¢ã‚«ãƒ«ãƒ†</h3>
        <button id="closeModal" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6">
        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="flex border-b border-gray-200 mb-6">
          <button class="tab-btn active px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600" data-tab="profile">
            ğŸ‘¤ åŸºæœ¬æƒ…å ±
          </button>
          <button class="tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="history">
            ğŸ“‹ æ–½è¡“å±¥æ­´
          </button>
          <button class="tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="photos">
            ğŸ“· æ–½è¡“å†™çœŸ
          </button>
          <button class="tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="notes">
            ğŸ“ ã‚«ãƒ«ãƒ†ãƒ¡ãƒ¢
          </button>
        </div>

        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ– -->
        <div id="profileTab" class="tab-content">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-semibold mb-4">åŸºæœ¬æƒ…å ±</h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">ãŠåå‰</label>
                  <input type="text" id="editName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">é›»è©±ç•ªå·</label>
                  <input type="tel" id="editPhone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">ç”Ÿå¹´æœˆæ—¥</label>
                  <input type="date" id="editBirthday" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">è·æ¥­</label>
                  <input type="text" id="editOccupation" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold mb-4">é«ªè³ªãƒ»è‚Œè³ªæƒ…å ±</h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">é«ªè³ª</label>
                  <select id="editHairType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ</option>
                    <option value="ã‚¦ã‚§ãƒ¼ãƒ–">ã‚¦ã‚§ãƒ¼ãƒ–</option>
                    <option value="ã‚«ãƒ¼ãƒ«">ã‚«ãƒ¼ãƒ«</option>
                    <option value="ãã›æ¯›">ãã›æ¯›</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">é«ªã®é‡</label>
                  <select id="editHairVolume" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="å°‘ãªã„">å°‘ãªã„</option>
                    <option value="æ™®é€š">æ™®é€š</option>
                    <option value="å¤šã„">å¤šã„</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
                  <textarea id="editAllergies" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">ç‰¹è¨˜äº‹é …</label>
                  <textarea id="editNotes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ã‚¿ã‚°ç®¡ç† -->
          <div class="mt-6">
            <h4 class="font-semibold mb-4">ã‚¿ã‚°ç®¡ç†</h4>
            <div class="flex flex-wrap gap-2 mb-4" id="customerTags">
              <!-- ã‚¿ã‚°ã¯å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            <div class="flex gap-2">
              <input type="text" id="newTagInput" placeholder="æ–°ã—ã„ã‚¿ã‚°ã‚’å…¥åŠ›" 
                     class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
              <button id="addTagBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                è¿½åŠ 
              </button>
            </div>
          </div>
          
          <div class="mt-6 flex justify-end">
            <button id="saveProfileBtn" class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600">
              ä¿å­˜
            </button>
          </div>
        </div>

        <!-- æ–½è¡“å±¥æ­´ã‚¿ãƒ– -->
        <div id="historyTab" class="tab-content hidden">
          <div class="space-y-4" id="treatmentHistory">
            <!-- æ–½è¡“å±¥æ­´ã¯å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

        <!-- æ–½è¡“å†™çœŸã‚¿ãƒ– -->
        <div id="photosTab" class="tab-content hidden">
          <div class="mb-4">
            <input type="file" id="photoUpload" accept="image/*" multiple class="hidden">
            <button onclick="document.getElementById('photoUpload').click()" 
                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
              ğŸ“· å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </button>
          </div>
          <div class="photo-grid" id="customerPhotos">
            <!-- å†™çœŸã¯å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

        <!-- ã‚«ãƒ«ãƒ†ãƒ¡ãƒ¢ã‚¿ãƒ– -->
        <div id="notesTab" class="tab-content hidden">
          <div class="mb-4">
            <button id="addNoteBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
              ğŸ“ æ–°è¦ãƒ¡ãƒ¢è¿½åŠ 
            </button>
          </div>
          <div class="space-y-4" id="customerNotes">
            <!-- ãƒ¡ãƒ¢ã¯å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <script>
    // Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyAK14FMyp7VGYZPakGDmLdgHsvvxT-b0TM",
      authDomain: "salone-ponte-fceca.firebaseapp.com",
      projectId: "salone-ponte-fceca",
      storageBucket: "salone-ponte-fceca.appspot.com",
      messagingSenderId: "463711728652",
      appId: "1:463711728652:web:59c749e11d201b26b86a29",
      measurementId: "G-MPWGTB6R7C"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let customersData = [];
    let currentCustomer = null;
    let filteredCustomers = [];

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadCustomers();
      setupEventListeners();
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('tagFilter').addEventListener('change', applyFilters);
      document.getElementById('visitFilter').addEventListener('change', applyFilters);
      document.getElementById('resetFilter').addEventListener('click', resetFilters);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«
      document.getElementById('closeModal').addEventListener('click', closeModal);
      
      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
      });

      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
      document.getElementById('saveProfileBtn').addEventListener('click', saveCustomerProfile);
      document.getElementById('addTagBtn').addEventListener('click', addCustomerTag);
      
      // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      document.getElementById('photoUpload').addEventListener('change', uploadPhotos);
      
      // ãƒ¡ãƒ¢è¿½åŠ 
      document.getElementById('addNoteBtn').addEventListener('click', addCustomerNote);

      // CSVå‡ºåŠ›
      document.getElementById('exportBtn').addEventListener('click', exportToCSV);
      
      // æ–°è¦é¡§å®¢è¿½åŠ 
      document.getElementById('addCustomerBtn').addEventListener('click', openNewCustomerModal);
    }

    // é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadCustomers() {
      try {
        const snapshot = await db.collection('customers').get();
        customersData = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const reservations = data.reservations || [];
          
          // çµ±è¨ˆè¨ˆç®—
          const totalVisits = reservations.length;
          const totalSpent = reservations.reduce((sum, r) => sum + (r.price || 0), 0);
          const lastVisit = reservations.length > 0 ? 
            new Date(Math.max(...reservations.map(r => new Date(r.datetime).getTime()))) : null;
          
          // ã‚¿ã‚°è‡ªå‹•åˆ¤å®š
          const autoTags = determineCustomerTags(totalSpent, totalVisits, lastVisit);
          const existingTags = data.tags || [];
          const allTags = [...new Set([...autoTags, ...existingTags])];
          
          customersData.push({
            id: doc.id,
            ...data,
            totalVisits,
            totalSpent,
            lastVisit,
            tags: allTags,
            daysSinceLastVisit: lastVisit ? 
              Math.floor((Date.now() - lastVisit.getTime()) / (1000 * 60 * 60 * 24)) : null
          });
        });
        
        filteredCustomers = [...customersData];
        renderCustomers();
        updateStatistics();
        
      } catch (error) {
        console.error('é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // é¡§å®¢ã‚¿ã‚°è‡ªå‹•åˆ¤å®š
    function determineCustomerTags(totalSpent, totalVisits, lastVisit) {
      const tags = [];
      const daysSinceLastVisit = lastVisit ? 
        Math.floor((Date.now() - lastVisit.getTime()) / (1000 * 60 * 60 * 24)) : 999;
      
      // VIPé¡§å®¢
      if (totalSpent >= 50000 && totalVisits >= 10) {
        tags.push('VIPé¡§å®¢');
      }
      // å¸¸é€£é¡§å®¢
      else if (totalVisits >= 5 && daysSinceLastVisit <= 60) {
        tags.push('å¸¸é€£é¡§å®¢');
      }
      // æ–°è¦é¡§å®¢
      else if (totalVisits <= 2) {
        tags.push('æ–°è¦é¡§å®¢');
      }
      
      // é›¢åãƒªã‚¹ã‚¯
      if (daysSinceLastVisit > 90) {
        tags.push('é›¢åãƒªã‚¹ã‚¯');
      }
      
      return tags;
    }

    // é¡§å®¢ä¸€è¦§è¡¨ç¤º
    function renderCustomers() {
      const tbody = document.getElementById('customerTable');
      tbody.innerHTML = '';

      filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 cursor-pointer';
        
        // ã‚¿ã‚°è¡¨ç¤º
        const tagsHtml = customer.tags.slice(0, 3).map(tag => {
          const tagClass = getTagClass(tag);
          return `<span class="tag ${tagClass}">${tag}</span>`;
        }).join(' ');
        
        const lastVisitText = customer.lastVisit ? 
          customer.lastVisit.toLocaleDateString('ja-JP') + 
          ` (${customer.daysSinceLastVisit}æ—¥å‰)` : 'æœªæ¥åº—';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                  <span class="text-sm font-medium text-gray-700">${customer.name ? customer.name.charAt(0) : '?'}</span>
                </div>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">${customer.name || 'åå‰æœªè¨­å®š'}</div>
                <div class="text-sm text-gray-500">${customer.phone || 'é›»è©±ç•ªå·æœªè¨­å®š'}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex flex-wrap gap-1">${tagsHtml}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${customer.totalVisits}å›æ¥åº—
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            Â¥${customer.totalSpent.toLocaleString()}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${lastVisitText}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button onclick="openCustomerModal('${customer.id}')" 
                    class="text-blue-600 hover:text-blue-900">è©³ç´°</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // ã‚¿ã‚°ã®CSSã‚¯ãƒ©ã‚¹å–å¾—
    function getTagClass(tag) {
      switch (tag) {
        case 'VIPé¡§å®¢': return 'tag-vip';
        case 'å¸¸é€£é¡§å®¢': return 'tag-regular';
        case 'æ–°è¦é¡§å®¢': return 'tag-new';
        case 'é›¢åãƒªã‚¹ã‚¯': return 'tag-risk';
        default: return 'tag-custom';
      }
    }

    // çµ±è¨ˆæ›´æ–°
    function updateStatistics() {
      const total = customersData.length;
      const thisMonth = new Date();
      thisMonth.setDate(1);
      
      const newThisMonth = customersData.filter(c => 
        c.createdAt && new Date(c.createdAt) >= thisMonth
      ).length;
      
      const vip = customersData.filter(c => c.tags.includes('VIPé¡§å®¢')).length;
      const risk = customersData.filter(c => c.tags.includes('é›¢åãƒªã‚¹ã‚¯')).length;
      
      document.getElementById('totalCustomers').textContent = total;
      document.getElementById('newCustomers').textContent = newThisMonth;
      document.getElementById('vipCustomers').textContent = vip;
      document.getElementById('riskCustomers').textContent = risk;
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const tagFilter = document.getElementById('tagFilter').value;
      const visitFilter = document.getElementById('visitFilter').value;
      
      filteredCustomers = customersData.filter(customer => {
        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (searchTerm) {
          const nameMatch = (customer.name || '').toLowerCase().includes(searchTerm);
          const phoneMatch = (customer.phone || '').toLowerCase().includes(searchTerm);
          if (!nameMatch && !phoneMatch) return false;
        }
        
        // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (tagFilter && !customer.tags.includes(tagFilter)) {
          return false;
        }
        
        // æ¥åº—æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (visitFilter) {
          const days = parseInt(visitFilter);
          if (days === 180) {
            // 180æ—¥ä»¥ä¸Šæ¥åº—ã—ã¦ã„ãªã„
            if (!customer.daysSinceLastVisit || customer.daysSinceLastVisit <= 180) {
              return false;
            }
          } else {
            // æŒ‡å®šæ—¥æ•°ä»¥å†…ã«æ¥åº—
            if (!customer.daysSinceLastVisit || customer.daysSinceLastVisit > days) {
              return false;
            }
          }
        }
        
        return true;
      });
      
      renderCustomers();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
    function resetFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('tagFilter').value = '';
      document.getElementById('visitFilter').value = '';
      filteredCustomers = [...customersData];
      renderCustomers();
    }

    // é¡§å®¢è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
    function openCustomerModal(customerId) {
      currentCustomer = customersData.find(c => c.id === customerId);
      if (!currentCustomer) return;
      
      document.getElementById('modalCustomerName').textContent = 
        `${currentCustomer.name || 'åå‰æœªè¨­å®š'} ã®ã‚«ãƒ«ãƒ†`;
      
      loadCustomerProfile();
      document.getElementById('customerModal').classList.add('active');
      switchTab('profile');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
    function closeModal() {
      document.getElementById('customerModal').classList.remove('active');
      currentCustomer = null;
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
        btn.classList.add('text-gray-500');
      });
      
      const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
      activeBtn.classList.add('active', 'border-blue-500', 'text-blue-600');
      activeBtn.classList.remove('text-gray-500');
      
      // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`${tabName}Tab`).classList.remove('hidden');
      
      // ã‚¿ãƒ–å›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      switch (tabName) {
        case 'history':
          loadTreatmentHistory();
          break;
        case 'photos':
          loadCustomerPhotos();
          break;
        case 'notes':
          loadCustomerNotes();
          break;
      }
    }

    // é¡§å®¢ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
    function loadCustomerProfile() {
      document.getElementById('editName').value = currentCustomer.name || '';
      document.getElementById('editPhone').value = currentCustomer.phone || '';
      document.getElementById('editBirthday').value = currentCustomer.birthday || '';
      document.getElementById('editOccupation').value = currentCustomer.occupation || '';
      document.getElementById('editHairType').value = currentCustomer.hairType || '';
      document.getElementById('editHairVolume').value = currentCustomer.hairVolume || '';
      document.getElementById('editAllergies').value = currentCustomer.allergies || '';
      document.getElementById('editNotes').value = currentCustomer.notes || '';
      
      // ã‚¿ã‚°è¡¨ç¤º
      renderCustomerTags();
    }

    // é¡§å®¢ã‚¿ã‚°è¡¨ç¤º
    function renderCustomerTags() {
      const container = document.getElementById('customerTags');
      container.innerHTML = '';
      
      if (currentCustomer.tags) {
        currentCustomer.tags.forEach(tag => {
          const tagElement = document.createElement('span');
          tagElement.className = `tag ${getTagClass(tag)} cursor-pointer`;
          tagElement.innerHTML = `${tag} <span onclick="removeTag('${tag}')" class="ml-1 text-red-500">Ã—</span>`;
          container.appendChild(tagElement);
        });
      }
    }

    // ã‚¿ã‚°è¿½åŠ 
    function addCustomerTag() {
      const newTag = document.getElementById('newTagInput').value.trim();
      if (!newTag) return;
      
      if (!currentCustomer.tags) {
        currentCustomer.tags = [];
      }
      
      if (!currentCustomer.tags.includes(newTag)) {
        currentCustomer.tags.push(newTag);
        renderCustomerTags();
        document.getElementById('newTagInput').value = '';
      }
    }

    // ã‚¿ã‚°å‰Šé™¤
    function removeTag(tag) {
      if (currentCustomer.tags) {
        currentCustomer.tags = currentCustomer.tags.filter(t => t !== tag);
        renderCustomerTags();
      }
    }

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜
    async function saveCustomerProfile() {
      try {
        const updatedData = {
          name: document.getElementById('editName').value.trim(),
          phone: document.getElementById('editPhone').value.trim(),
          birthday: document.getElementById('editBirthday').value,
          occupation: document.getElementById('editOccupation').value.trim(),
          hairType: document.getElementById('editHairType').value,
          hairVolume: document.getElementById('editHairVolume').value,
          allergies: document.getElementById('editAllergies').value.trim(),
          notes: document.getElementById('editNotes').value.trim(),
          tags: currentCustomer.tags || [],
          updatedAt: new Date().toISOString()
        };
        
        await db.collection('customers').doc(currentCustomer.id).update(updatedData);
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        Object.assign(currentCustomer, updatedData);
        const index = customersData.findIndex(c => c.id === currentCustomer.id);
        if (index !== -1) {
          Object.assign(customersData[index], updatedData);
        }
        
        alert('é¡§å®¢æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        renderCustomers();
        
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // æ–½è¡“å±¥æ­´èª­ã¿è¾¼ã¿
    function loadTreatmentHistory() {
      const container = document.getElementById('treatmentHistory');
      container.innerHTML = '';
      
      if (!currentCustomer.reservations || currentCustomer.reservations.length === 0) {
        container.innerHTML = '<p class="text-gray-500">æ–½è¡“å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      // æ–½è¡“å±¥æ­´ã‚’æ—¥ä»˜é™é †ã§ã‚½ãƒ¼ãƒˆ
      const sortedHistory = [...currentCustomer.reservations].sort((a, b) => 
        new Date(b.datetime) - new Date(a.datetime)
      );
      
      sortedHistory.forEach(treatment => {
        const historyItem = document.createElement('div');
        historyItem.className = 'bg-gray-50 rounded-lg p-4';
        historyItem.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h5 class="font-semibold">${treatment.menu}</h5>
            <span class="text-sm text-gray-500">${new Date(treatment.datetime).toLocaleDateString('ja-JP')}</span>
          </div>
          <div class="text-sm text-gray-600">
            <p>æ‹…å½“: ${treatment.staff}</p>
            <p>æ–™é‡‘: Â¥${(treatment.price || 0).toLocaleString()}</p>
            ${treatment.note ? `<p class="mt-2">${treatment.note}</p>` : ''}
          </div>
        `;
        container.appendChild(historyItem);
      });
    }

    // æ–½è¡“å†™çœŸèª­ã¿è¾¼ã¿
    function loadCustomerPhotos() {
      const container = document.getElementById('customerPhotos');
      container.innerHTML = '';
      
      // å®Ÿè£…ä¾‹ï¼šFirestoreã‹ã‚‰å†™çœŸURLã‚’å–å¾—
      // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€é¡§å®¢ã”ã¨ã®å†™çœŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
      if (currentCustomer.photos && currentCustomer.photos.length > 0) {
        currentCustomer.photos.forEach(photo => {
          const photoItem = document.createElement('div');
          photoItem.className = 'photo-item';
          photoItem.innerHTML = `
            <img src="${photo.url}" alt="æ–½è¡“å†™çœŸ" onclick="openPhotoModal('${photo.url}')">
            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1">
              ${new Date(photo.date).toLocaleDateString('ja-JP')}
            </div>
          `;
          container.appendChild(photoItem);
        });
      } else {
        container.innerHTML = '<p class="text-gray-500 text-center col-span-full">å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</p>';
      }
    }

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    async function uploadPhotos(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;
      
      try {
        const uploadPromises = files.map(async (file) => {
          const fileName = `customers/${currentCustomer.id}/${Date.now()}_${file.name}`;
          const storageRef = storage.ref().child(fileName);
          const snapshot = await storageRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();
          
          return {
            url: downloadURL,
            date: new Date().toISOString(),
            fileName: file.name
          };
        });
        
        const uploadedPhotos = await Promise.all(uploadPromises);
        
        // Firestoreã«å†™çœŸæƒ…å ±ã‚’ä¿å­˜
        const currentPhotos = currentCustomer.photos || [];
        const updatedPhotos = [...currentPhotos, ...uploadedPhotos];
        
        await db.collection('customers').doc(currentCustomer.id).update({
          photos: updatedPhotos
        });
        
        currentCustomer.photos = updatedPhotos;
        loadCustomerPhotos();
        
        alert('å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        
      } catch (error) {
        console.error('å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        alert('å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚«ãƒ«ãƒ†ãƒ¡ãƒ¢èª­ã¿è¾¼ã¿
    function loadCustomerNotes() {
      const container = document.getElementById('customerNotes');
      container.innerHTML = '';
      
      if (!currentCustomer.customerNotes || currentCustomer.customerNotes.length === 0) {
        container.innerHTML = '<p class="text-gray-500">ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      // ãƒ¡ãƒ¢ã‚’æ—¥ä»˜é™é †ã§ã‚½ãƒ¼ãƒˆ
      const sortedNotes = [...currentCustomer.customerNotes].sort((a, b) => 
        new Date(b.createdAt) - new Date(a.createdAt)
      );
      
      sortedNotes.forEach((note, index) => {
        const noteItem = document.createElement('div');
        noteItem.className = 'bg-gray-50 rounded-lg p-4';
        noteItem.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h5 class="font-semibold">${note.title || `ãƒ¡ãƒ¢ ${index + 1}`}</h5>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-500">${new Date(note.createdAt).toLocaleDateString('ja-JP')}</span>
              <button onclick="deleteNote(${index})" class="text-red-500 hover:text-red-700">å‰Šé™¤</button>
            </div>
          </div>
          <div class="text-sm text-gray-700">${note.content}</div>
          ${note.author ? `<div class="text-xs text-gray-500 mt-2">ä½œæˆè€…: ${note.author}</div>` : ''}
        `;
        container.appendChild(noteItem);
      });
    }

    // ãƒ¡ãƒ¢è¿½åŠ 
    function addCustomerNote() {
      const title = prompt('ãƒ¡ãƒ¢ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (!title) return;
      
      const content = prompt('ãƒ¡ãƒ¢ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (!content) return;
      
      const newNote = {
        title: title,
        content: content,
        createdAt: new Date().toISOString(),
        author: 'ã‚¹ã‚¿ãƒƒãƒ•' // å®Ÿéš›ã«ã¯ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¹ã‚¿ãƒƒãƒ•å
      };
      
      if (!currentCustomer.customerNotes) {
        currentCustomer.customerNotes = [];
      }
      
      currentCustomer.customerNotes.push(newNote);
      
      // Firestoreã«ä¿å­˜
      db.collection('customers').doc(currentCustomer.id).update({
        customerNotes: currentCustomer.customerNotes
      }).then(() => {
        loadCustomerNotes();
        alert('ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      }).catch(error => {
        console.error('ãƒ¡ãƒ¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    // ãƒ¡ãƒ¢å‰Šé™¤
    async function deleteNote(index) {
      if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      try {
        currentCustomer.customerNotes.splice(index, 1);
        
        await db.collection('customers').doc(currentCustomer.id).update({
          customerNotes: currentCustomer.customerNotes
        });
        
        loadCustomerNotes();
        alert('ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        
      } catch (error) {
        console.error('ãƒ¡ãƒ¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒ¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // CSVå‡ºåŠ›
    function exportToCSV() {
      const headers = [
        'é¡§å®¢ID', 'åå‰', 'é›»è©±ç•ªå·', 'ç”Ÿå¹´æœˆæ—¥', 'è·æ¥­', 
        'é«ªè³ª', 'é«ªã®é‡', 'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼', 'ã‚¿ã‚°', 'æ¥åº—å›æ•°', 
        'ç´¯è¨ˆé‡‘é¡', 'æœ€çµ‚æ¥åº—æ—¥', 'åˆå›æ¥åº—æ—¥'
      ];
      
      const csvData = filteredCustomers.map(customer => [
        customer.id,
        customer.name || '',
        customer.phone || '',
        customer.birthday || '',
        customer.occupation || '',
        customer.hairType || '',
        customer.hairVolume || '',
        customer.allergies || '',
        (customer.tags || []).join(';'),
        customer.totalVisits,
        customer.totalSpent,
        customer.lastVisit ? customer.lastVisit.toLocaleDateString('ja-JP') : '',
        customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('ja-JP') : ''
      ]);
      
      const csvContent = [headers, ...csvData]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');
      
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `é¡§å®¢ä¸€è¦§_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // æ–°è¦é¡§å®¢è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openNewCustomerModal() {
      const name = prompt('ãŠå®¢æ§˜ã®ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (!name) return;
      
      const phone = prompt('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (!phone) return;
      
      createNewCustomer(name, phone);
    }
    
    // æ–°è¦é¡§å®¢ä½œæˆ
    async function createNewCustomer(name, phone) {
      try {
        const newCustomer = {
          name: name.trim(),
          phone: phone.trim(),
          createdAt: new Date().toISOString(),
          tags: ['æ–°è¦é¡§å®¢'],
          reservations: [],
          notes: '',
          allergies: '',
          hairType: '',
          hairVolume: '',
          occupation: '',
          birthday: '',
          photos: [],
          customerNotes: []
        };
        
        const docRef = await db.collection('customers').add(newCustomer);
        newCustomer.id = docRef.id;
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
        customersData.push({
          ...newCustomer,
          totalVisits: 0,
          totalSpent: 0,
          lastVisit: null,
          daysSinceLastVisit: null
        });
        
        filteredCustomers = [...customersData];
        renderCustomers();
        updateStatistics();
        
        alert('æ–°è¦é¡§å®¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        
        // è©³ç´°ç·¨é›†ã®ãŸã‚ã«å³åº§ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        openCustomerModal(docRef.id);
        
      } catch (error) {
        console.error('æ–°è¦é¡§å®¢ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('é¡§å®¢ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
    window.openCustomerModal = openCustomerModal;
    window.removeTag = removeTag;
    window.deleteNote = deleteNote;
    window.openPhotoModal = function(photoUrl) {
      // å†™çœŸæ‹¡å¤§è¡¨ç¤ºã®ãƒ¢ãƒ¼ãƒ€ãƒ«å®Ÿè£…
      window.open(photoUrl, '_blank');
    };
  </script>
</body>
</html>basejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/fire